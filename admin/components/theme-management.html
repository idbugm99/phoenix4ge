<!-- Theme Management Component -->
<div id="theme-management-section" class="container-fluid" data-loaded="false">
    <div class="row">
        <div class="col-12">
            <!-- Header Section -->
            <div class="card shadow-sm border-0 mb-4">
                <div class="card-body">
                    <div class="row align-items-center">
                        <div class="col">
                            <h2 class="mb-1 fw-bold text-primary">
                                <i class="fas fa-palette me-3"></i>Theme Management
                            </h2>
                            <p class="mb-0 text-muted">Assign and manage themes for model portfolios</p>
                        </div>
                        <div class="col-auto">
                            <button class="btn btn-primary" onclick="showThemePreview()">
                                <i class="fas fa-eye me-2"></i>Preview All Themes
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Theme Statistics -->
            <div class="row mb-4">
                <div class="col-md-3 col-sm-6 mb-3">
                    <div class="kpi-card">
                        <div class="kpi-icon bg-primary">
                            <i class="fas fa-palette"></i>
                        </div>
                        <div class="kpi-content">
                            <div class="kpi-title">Available Themes</div>
                            <div class="kpi-value" id="totalThemes">5</div>
                        </div>
                    </div>
                </div>
                <div class="col-md-3 col-sm-6 mb-3">
                    <div class="kpi-card">
                        <div class="kpi-icon bg-success">
                            <i class="fas fa-users"></i>
                        </div>
                        <div class="kpi-content">
                            <div class="kpi-title">Assigned Models</div>
                            <div class="kpi-value" id="assignedModels">0</div>
                        </div>
                    </div>
                </div>
                <div class="col-md-3 col-sm-6 mb-3">
                    <div class="kpi-card">
                        <div class="kpi-icon bg-warning">
                            <i class="fas fa-star"></i>
                        </div>
                        <div class="kpi-content">
                            <div class="kpi-title">Most Popular</div>
                            <div class="kpi-value" id="popularTheme">Glamour</div>
                        </div>
                    </div>
                </div>
                <div class="col-md-3 col-sm-6 mb-3">
                    <div class="kpi-card">
                        <div class="kpi-icon bg-info">
                            <i class="fas fa-clock"></i>
                        </div>
                        <div class="kpi-content">
                            <div class="kpi-title">Last Updated</div>
                            <div class="kpi-value" id="lastUpdated">Today</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Navigation Tabs -->
            <div class="row mb-4">
                <div class="col-12">
                    <ul class="nav nav-pills nav-fill bg-light rounded-3 p-2" id="themeManagementTabs" role="tablist">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link active rounded-3 fw-semibold" id="themes-tab" data-bs-toggle="pill" data-bs-target="#themes-pane" type="button" role="tab">
                                <i class="fas fa-palette me-2"></i>Theme Gallery
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link rounded-3 fw-semibold" id="gallery-assignment-tab" data-bs-toggle="pill" data-bs-target="#gallery-assignment-pane" type="button" role="tab">
                                <i class="fas fa-images me-2"></i>Gallery Assignment
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link rounded-3 fw-semibold" id="color-palettes-tab" data-bs-toggle="pill" data-bs-target="#color-palettes-pane" type="button" role="tab">
                                <i class="fas fa-swatchbook me-2"></i>Color Palettes
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link rounded-3 fw-semibold" id="model-assignment-tab" data-bs-toggle="pill" data-bs-target="#model-assignment-pane" type="button" role="tab">
                                <i class="fas fa-users-cog me-2"></i>Model Assignment
                            </button>
                        </li>
                    </ul>
                </div>
            </div>

            <!-- Tab Content -->
            <div class="tab-content" id="themeManagementTabContent">
                
                <!-- Theme Gallery Tab -->
                <div class="tab-pane fade show active" id="themes-pane" role="tabpanel" aria-labelledby="themes-tab">
                    <!-- Theme Gallery -->
            <div class="card shadow-sm border-0 mb-4">
                <div class="card-header bg-light">
                    <h5 class="mb-0 fw-bold">
                        <i class="fas fa-th-large me-2"></i>Theme Gallery
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row" id="themeGallery">
                        <!-- Themes will be loaded here -->
                    </div>
                </div>
            </div>
                </div>

                <!-- Gallery Assignment Tab -->
                <div class="tab-pane fade" id="gallery-assignment-pane" role="tabpanel" aria-labelledby="gallery-assignment-tab">
                    <div class="card shadow-sm border-0 mb-4">
                        <div class="card-header bg-light">
                            <h5 class="mb-0 fw-bold">
                                <i class="fas fa-images me-2"></i>Theme Gallery Profile Assignment
                            </h5>
                            <p class="text-muted mb-0 mt-1">Assign gallery profiles to themes for automatic gallery behavior</p>
                        </div>
                        <div class="card-body">
                            <div class="alert alert-info">
                                <h6><i class="fas fa-info-circle me-2"></i>Gallery Assignment Logic</h6>
                                <p class="mb-0">When a model uses a theme, the assigned gallery profile determines how their galleries display. This creates consistent gallery behavior across all models using the same theme.</p>
                            </div>
                            
                            <div id="themeGalleryAssignmentMatrix">
                                <!-- Gallery assignment matrix will be loaded here -->
                                <div class="text-center py-4">
                                    <div class="spinner-border text-primary mb-3" role="status">
                                        <span class="visually-hidden">Loading...</span>
                                    </div>
                                    <p class="text-muted">Loading theme gallery assignments...</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Color Palettes Tab -->
                <div class="tab-pane fade" id="color-palettes-pane" role="tabpanel" aria-labelledby="color-palettes-tab">
                    <div class="card shadow-sm border-0">
                        <div class="card-header bg-light">
                            <div class="row align-items-center">
                                <div class="col">
                                    <h5 class="mb-0 fw-bold">
                                        <i class="fas fa-swatchbook me-2"></i>Color Palette Management
                                    </h5>
                                    <p class="mb-0 text-muted small">Manage color palettes for Model Example</p>
                                </div>
                                <div class="col-auto">
                                    <button class="btn btn-primary btn-sm" onclick="createCustomPalette()">
                                        <i class="fas fa-plus me-1"></i>Create Custom Palette
                                    </button>
                                </div>
                            </div>
                        </div>
                        <div class="card-body">
                            <!-- Current Theme & Palette Info -->
                            <div class="alert alert-info mb-4" id="currentThemePaletteInfo">
                                <div class="row align-items-center">
                                    <div class="col-md-6">
                                        <strong>Current Theme:</strong> <span id="currentThemeName">Loading...</span>
                                    </div>
                                    <div class="col-md-6">
                                        <strong>Active Palette:</strong> <span id="currentPaletteName">Loading...</span>
                                        <span id="customPaletteBadge" class="badge bg-secondary ms-2" style="display: none;">Custom</span>
                                    </div>
                                </div>
                            </div>

                            <!-- Available Palettes -->
                            <div class="row mb-4">
                                <div class="col-12">
                                    <h6 class="fw-bold">Available Color Palettes</h6>
                                    <div id="paletteGrid" class="row g-3">
                                        <!-- Palette cards will be populated here -->
                                        <div class="col-12 text-center py-4">
                                            <div class="spinner-border text-primary mb-3" role="status">
                                                <span class="visually-hidden">Loading...</span>
                                            </div>
                                            <p class="text-muted">Loading color palettes...</p>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Color Token Editor -->
                            <div class="card border-secondary" id="colorTokenEditor" style="display: none;">
                                <div class="card-header bg-secondary text-white">
                                    <h6 class="mb-0">
                                        <i class="fas fa-paint-brush me-2"></i>Color Token Editor
                                        <span class="badge bg-light text-dark ms-2" id="editingPaletteName"></span>
                                    </h6>
                                </div>
                                <div class="card-body">
                                    <div class="row" id="colorTokenGrid">
                                        <!-- Color tokens will be populated here -->
                                    </div>
                                    <div class="row mt-3">
                                        <div class="col-12">
                                            <button class="btn btn-success me-2" onclick="saveColorChanges()">
                                                <i class="fas fa-save me-1"></i>Save Changes
                                            </button>
                                            <button class="btn btn-secondary" onclick="cancelColorEditing()">
                                                <i class="fas fa-times me-1"></i>Cancel
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Model Assignment Tab -->
                <div class="tab-pane fade" id="model-assignment-pane" role="tabpanel" aria-labelledby="model-assignment-tab">
                    <!-- Model Assignment Section -->
            <div class="card shadow-sm border-0">
                <div class="card-header bg-light">
                    <h5 class="mb-0 fw-bold">
                        <i class="fas fa-users-cog me-2"></i>Model Theme Assignments
                    </h5>
                </div>
                <div class="card-body">
                    <!-- Search and Filter -->
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <div class="input-group">
                                <span class="input-group-text">
                                    <i class="fas fa-search"></i>
                                </span>
                                <input type="text" class="form-control" id="modelSearchInput" 
                                       placeholder="Search models..." onkeyup="filterModels()">
                            </div>
                        </div>
                        <div class="col-md-3">
                            <select class="form-select" id="themeFilter" onchange="filterByTheme()">
                                <option value="">All Themes</option>
                                <!-- Theme options will be populated dynamically -->
                            </select>
                        </div>
                        <div class="col-md-3">
                            <select class="form-select" id="statusFilter" onchange="filterByStatus()">
                                <option value="">All Status</option>
                                <option value="assigned">Assigned</option>
                                <option value="unassigned">Unassigned</option>
                            </select>
                        </div>
                    </div>

                    <!-- Models Table -->
                    <div class="table-responsive">
                        <table class="table table-hover align-middle">
                            <thead class="table-light">
                                <tr>
                                    <th>Model</th>
                                    <th>Current Theme</th>
                                    <th>Status</th>
                                    <th>Last Updated</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="modelsTableBody">
                                <!-- Models will be loaded here -->
                            </tbody>
                        </table>
                    </div>

                    <!-- Pagination -->
                    <nav aria-label="Models pagination">
                        <ul class="pagination justify-content-center mb-0" id="modelsPagination">
                            <!-- Pagination will be generated here -->
                        </ul>
                    </nav>
                </div>
            </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Theme Preview Modal -->
<div class="modal fade" id="themePreviewModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-eye me-2"></i>Theme Preview
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body p-0">
                <div class="row g-0">
                    <div class="col-md-3 bg-light p-3">
                        <h6 class="fw-bold mb-3">Available Themes</h6>
                        <div class="list-group list-group-flush" id="themePreviewList">
                            <!-- Theme list will be generated -->
                        </div>
                    </div>
                    <div class="col-md-9">
                        <div class="ratio ratio-16x9">
                            <iframe id="themePreviewFrame" src="" class="border-0"></iframe>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" onclick="assignPreviewTheme()">
                    <i class="fas fa-check me-2"></i>Assign This Theme
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Theme Assignment Modal -->
<div class="modal fade" id="themeAssignmentModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-palette me-2"></i>Assign Theme
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="themeAssignmentForm">
                    <input type="hidden" id="assignmentModelId">
                    
                    <div class="mb-3">
                        <label class="form-label fw-bold">Model</label>
                        <div class="form-control-plaintext" id="assignmentModelName"></div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="assignmentTheme" class="form-label fw-bold">Select Theme</label>
                        <select class="form-select" id="assignmentTheme" required>
                            <option value="">Choose a theme...</option>
                            <!-- Theme options will be populated dynamically -->
                        </select>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label fw-bold">Theme Preview</label>
                        <div class="border rounded p-3 bg-light" id="themePreviewCard">
                            <p class="text-muted mb-0">Select a theme to see preview</p>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="enableCustomColors">
                            <label class="form-check-label" for="enableCustomColors">
                                Enable custom color scheme
                            </label>
                        </div>
                    </div>
                    
                    <div id="customColorSection" class="d-none">
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="primaryColor" class="form-label">Primary Color</label>
                                <input type="color" class="form-control form-control-color" id="primaryColor">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="accentColor" class="form-label">Accent Color</label>
                                <input type="color" class="form-control form-control-color" id="accentColor">
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="saveThemeAssignment()">
                    <i class="fas fa-save me-2"></i>Assign Theme
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Theme CSS Editor Modal -->
<div class="modal fade" id="themeCSSEditorModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header bg-warning text-dark">
                <h5 class="modal-title fw-bold" id="themeCSSEditorTitle">
                    <i class="fas fa-edit me-2"></i>Edit Theme CSS
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="row mb-3">
                    <div class="col-12">
                        <div class="alert alert-info">
                            <h6><i class="fas fa-info-circle me-2"></i>CSS Customization Guidelines</h6>
                            <ul class="mb-0 small">
                                <li>Use CSS custom properties (--variable-name) for easy theming</li>
                                <li>Focus on gallery-specific styling (colors, spacing, animations)</li>
                                <li>Avoid breaking existing layout structure</li>
                                <li>Test changes with the Preview button before saving</li>
                            </ul>
                        </div>
                    </div>
                </div>
                
                <div class="row">
                    <div class="col-12">
                        <label for="cssEditor" class="form-label fw-bold">Theme CSS</label>
                        <textarea id="cssEditor" class="form-control font-monospace" rows="20" 
                                  placeholder="Enter theme-specific CSS here..."></textarea>
                    </div>
                </div>
                
                <div class="row mt-3">
                    <div class="col-12">
                        <div class="d-flex gap-2">
                            <button class="btn btn-info btn-sm" onclick="window.themeManager.previewThemeCSS()">
                                <i class="fas fa-eye me-1"></i>Preview Changes
                            </button>
                            <button class="btn btn-secondary btn-sm" onclick="window.themeManager.resetThemeCSS()">
                                <i class="fas fa-undo me-1"></i>Reset to Default
                            </button>
                            <button class="btn btn-outline-secondary btn-sm" onclick="window.themeManager.formatCSS()">
                                <i class="fas fa-code me-1"></i>Format CSS
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-warning" onclick="window.themeManager.saveThemeCSS()">
                    <i class="fas fa-save me-2"></i>Save CSS Changes
                </button>
            </div>
        </div>
    </div>
</div>

<style>
/* Theme Management Specific Styles */
.theme-card {
    border: 2px solid #e9ecef;
    border-radius: 12px;
    overflow: hidden;
    transition: all 0.3s ease;
    cursor: pointer;
}

.theme-card:hover {
    border-color: var(--primary-color);
    transform: translateY(-2px);
    box-shadow: 0 8px 25px rgba(0,0,0,0.1);
}

.theme-card.selected {
    border-color: var(--primary-color);
    box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
}

.theme-preview {
    height: 200px;
    background-size: cover;
    background-position: center;
    position: relative;
}

.theme-overlay {
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: linear-gradient(45deg, rgba(0,0,0,0.1), rgba(0,0,0,0.3));
    display: flex;
    align-items: center;
    justify-content: center;
    opacity: 0;
    transition: opacity 0.3s ease;
}

.theme-card:hover .theme-overlay {
    opacity: 1;
}

.theme-badge {
    position: absolute;
    top: 10px;
    right: 10px;
    font-size: 0.75rem;
    padding: 4px 8px;
}

.model-status-badge {
    font-size: 0.75rem;
    padding: 4px 8px;
    border-radius: 12px;
}

.status-assigned {
    background-color: #d4edda;
    color: #155724;
}

.status-unassigned {
    background-color: #f8d7da;
    color: #721c24;
}

.theme-color-preview {
    width: 20px;
    height: 20px;
    border-radius: 50%;
    display: inline-block;
    margin-right: 8px;
    border: 2px solid #fff;
    box-shadow: 0 0 0 1px rgba(0,0,0,0.1);
}
</style>

<script>
if (typeof window.ThemeManagement === 'undefined') {
window.ThemeManagement = class ThemeManagement {
    constructor() {
        this.themes = [];
        
        this.models = [];
        this.selectedTheme = null;
        this.selectedModel = null;
        
        this.init();
    }
    
    async init() {
        console.log('üöÄ Initializing Theme Management...');
        await this.loadThemes();
        await this.loadModels();
        console.log('üìä Themes loaded:', this.themes.length);
        console.log('üìä Models loaded:', this.models.length);
        this.updateStatistics();
        this.populateThemeDropdowns();
        this.renderThemeGallery();
        this.renderModelsTable();
        this.loadGalleryProfiles();
        await this.initColorPalettes();
        this.setupEventListeners();
        console.log('‚úÖ Theme Management initialized successfully');
    }
    
    async loadThemes() {
        try {
            console.log('üé® Fetching themes from database...');
            const response = await sysFetch('/api/theme-management/themes');
            if (response.ok) {
                const result = await response.json();
                const dbThemes = result.data.themes;
                this.themes = dbThemes.map(theme => ({
                    id: theme.id,
                    slug: theme.name.toLowerCase().replace(/\s+/g, '_'),
                    name: theme.name,
                    description: theme.description || 'Theme description',
                    primaryColor: theme.primary_color || this.getDefaultColor(theme.name),
                    accentColor: theme.accent_color || this.getDefaultAccent(theme.name),
                    previewUrl: `/modelexample?preview_theme=${theme.id}`,
                    thumbnail: this.generateThumbnail(theme.name, theme.primary_color || this.getDefaultColor(theme.name))
                }));
                console.log('‚úÖ Loaded', this.themes.length, 'themes from database');
                console.log('Themes:', this.themes);
            } else {
                throw new Error('Failed to load themes from API');
            }
        } catch (error) {
            console.error('‚ùå Error loading themes:', error);
            // Fallback to hardcoded themes if API fails
            this.themes = this.getDefaultThemes();
        }
    }
    
    getDefaultColor(themeName) {
        const colors = {
            'basic': '#1F2937',
            'glamour': '#EC4899', 
            'luxury': '#D97706',
            'modern': '#2563EB',
            'dark': '#00ff88',
            'rose': '#E11D48'
        };
        return colors[themeName] || '#6B7280';
    }
    
    getDefaultAccent(themeName) {
        const colors = {
            'basic': '#10B981',
            'glamour': '#F97316',
            'luxury': '#92400E', 
            'modern': '#06B6D4',
            'dark': '#ff0088',
            'rose': '#F472B6'
        };
        return colors[themeName] || '#9CA3AF';
    }
    
    generateThumbnail(name, color) {
        return `data:image/svg+xml;base64,${btoa(`<svg width="300" height="200" xmlns="http://www.w3.org/2000/svg"><rect width="100%" height="100%" fill="${color}"/><text x="50%" y="50%" font-family="Arial" font-size="20" fill="white" text-anchor="middle" dy=".3em">${name}</text></svg>`)}`;
    }
    
    getDefaultThemes() {
        return [
            {id: 1, slug: 'basic', name: 'Basic', description: 'Professional & Clean', primaryColor: '#1F2937', accentColor: '#10B981', previewUrl: '/modelexample?preview_theme=1', thumbnail: this.generateThumbnail('Basic', '#1F2937')},
            {id: 2, slug: 'glamour', name: 'Glamour', description: 'Pink & Stylish', primaryColor: '#EC4899', accentColor: '#F97316', previewUrl: '/modelexample?preview_theme=2', thumbnail: this.generateThumbnail('Glamour', '#EC4899')},
            {id: 3, slug: 'luxury', name: 'Luxury', description: 'Gold & Elegant', primaryColor: '#D97706', accentColor: '#92400E', previewUrl: '/modelexample?preview_theme=3', thumbnail: this.generateThumbnail('Luxury', '#D97706')},
            {id: 4, slug: 'modern', name: 'Modern', description: 'Contemporary & Sleek', primaryColor: '#2563EB', accentColor: '#06B6D4', previewUrl: '/modelexample?preview_theme=4', thumbnail: this.generateThumbnail('Modern', '#2563EB')},
            {id: 5, slug: 'dark', name: 'Dark', description: 'Cyberpunk & Edgy', primaryColor: '#00ff88', accentColor: '#ff0088', previewUrl: '/modelexample?preview_theme=5', thumbnail: this.generateThumbnail('Dark', '#00ff88')}
        ];
    }
    
    updateStatistics() {
        document.getElementById('totalThemes').textContent = this.themes.length;
        document.getElementById('assignedModels').textContent = this.models.filter(m => m.theme_set_id).length;
    }
    
    populateThemeDropdowns() {
        // Populate theme filter dropdown
        const themeFilter = document.getElementById('themeFilter');
        const assignmentTheme = document.getElementById('assignmentTheme');
        
        const filterOptions = this.themes.map(theme => 
            `<option value="${theme.slug}">${theme.name}</option>`
        ).join('');
        
        const assignmentOptions = this.themes.map(theme => 
            `<option value="${theme.slug}">${theme.name} - ${theme.description}</option>`
        ).join('');
        
        if (themeFilter) {
            themeFilter.innerHTML = '<option value="">All Themes</option>' + filterOptions;
        }
        
        if (assignmentTheme) {
            assignmentTheme.innerHTML = '<option value="">Choose a theme...</option>' + assignmentOptions;
        }
    }
    
    async loadModels() {
        try {
            console.log('üîç Fetching models from API...');
            const response = await sysFetch('/api/theme-management/models');
            if (response.ok) {
                this.models = await response.json();
                console.log('‚úÖ Models loaded from API:', this.models);
                
                // Update the assigned models count
                document.getElementById('assignedModels').textContent = 
                    this.models.filter(m => m.theme_set_id).length;
            } else {
                console.log('‚ùå API response not OK, using sample data');
                this.models = [
                    { id: 1, name: 'Escort Example', slug: 'escortexample', theme_set_id: null, status: 'active' },
                    { id: 2, name: 'Cam Girl Demo', slug: 'camgirl-demo', theme_set_id: 'glamour', status: 'active' },
                    { id: 3, name: 'Luxury Model', slug: 'luxury-model', theme_set_id: 'luxury', status: 'active' }
                ];
            }
        } catch (error) {
            console.error('‚ùå Error loading models:', error);
            console.log('Using sample model data for demo');
            this.models = [
                { id: 1, name: 'Escort Example', slug: 'escortexample', theme_set_id: null, status: 'active' },
                { id: 2, name: 'Cam Girl Demo', slug: 'camgirl-demo', theme_set_id: 'glamour', status: 'active' },
                { id: 3, name: 'Luxury Model', slug: 'luxury-model', theme_set_id: 'luxury', status: 'active' }
            ];
        }
    }
    
    renderThemeGallery() {
        console.log('üé® Rendering theme gallery with', this.themes.length, 'themes');
        const gallery = document.getElementById('themeGallery');
        if (!gallery) {
            console.error('‚ùå Theme gallery container not found');
            return;
        }
        
        // Debug: Check visibility of gallery and parent tab pane
        let debugTabPane = gallery.closest('.tab-pane');
        if (debugTabPane) {
            console.log('üîç Tab pane visibility:', {
                id: debugTabPane.id,
                classList: Array.from(debugTabPane.classList),
                display: getComputedStyle(debugTabPane).display,
                opacity: getComputedStyle(debugTabPane).opacity,
                visibility: getComputedStyle(debugTabPane).visibility
            });
        }
        
        // Check if gallery is already populated to avoid unnecessary re-renders
        if (gallery.children.length > 0 && gallery.innerHTML.includes('theme-card')) {
            console.log('üîÑ Gallery already populated, skipping re-render');
            return;
        }
        const themesHtml = this.themes.map(theme => `
            <div class="col-md-4 col-lg-3 mb-4">
                <div class="theme-card" onclick="window.themeManager.selectTheme('${theme.slug}')">
                    <div class="theme-preview" style="background-image: url('${theme.thumbnail}')">
                        <div class="theme-overlay">
                            <div class="d-flex gap-2">
                                <button class="btn btn-light btn-sm" onclick="event.stopPropagation(); window.themeManager.openPreview('${theme.slug}')">
                                    <i class="fas fa-eye me-1"></i>Preview
                                </button>
                                <button class="btn btn-warning btn-sm" onclick="event.stopPropagation(); window.themeManager.editThemeCSS(${theme.id}, '${theme.name}')">
                                    <i class="fas fa-edit me-1"></i>Edit CSS
                                </button>
                            </div>
                        </div>
                        <span class="badge bg-primary theme-badge">${theme.name}</span>
                    </div>
                    <div class="card-body p-3">
                        <h6 class="card-title mb-1">${theme.name}</h6>
                        <p class="card-text text-muted small mb-2">${theme.description}</p>
                        <div class="d-flex align-items-center">
                            <div class="theme-color-preview" style="background-color: ${theme.primaryColor}"></div>
                            <div class="theme-color-preview" style="background-color: ${theme.accentColor}"></div>
                            <small class="text-muted ms-auto">
                                ${this.models.filter(m => m.theme_set_id === theme.id).length} assigned
                            </small>
                        </div>
                    </div>
                </div>
            </div>
        `).join('');
        
        console.log('üñºÔ∏è Setting gallery innerHTML with', themesHtml.length, 'characters of HTML');
        gallery.innerHTML = themesHtml;
        console.log('‚úÖ Theme gallery rendered successfully');
        
        // Force tab pane visibility debugging
        let forceTabPane = gallery.closest('.tab-pane');
        if (forceTabPane) {
            // Force visibility
            forceTabPane.style.display = 'block';
            forceTabPane.style.opacity = '1';
            forceTabPane.style.visibility = 'visible';
            
            console.log('üîß Forced tab pane visibility:', {
                id: forceTabPane.id,
                display: forceTabPane.style.display,
                opacity: forceTabPane.style.opacity,
                visibility: forceTabPane.style.visibility
            });
            
            // Also ensure the tab is properly activated
            let fixTabButton = document.getElementById('themes-tab');
            if (fixTabButton) {
                fixTabButton.classList.add('active');
                forceTabPane.classList.add('show', 'active');
                console.log('üîß Ensured tab and pane are active');
            }
            
            // Check Bootstrap availability
            if (typeof bootstrap !== 'undefined') {
                console.log('‚úÖ Bootstrap JavaScript is available');
            } else {
                console.log('‚ö†Ô∏è Bootstrap JavaScript not available - may cause tab issues');
            }
        }
        
        // Debug: Set up MutationObserver to track changes
        if (!gallery.hasAttribute('data-observer-set')) {
            const observer = new MutationObserver((mutations) => {
                mutations.forEach((mutation) => {
                    if (mutation.type === 'childList' && gallery.innerHTML.trim() === '') {
                        console.error('üö® GALLERY CLEARED! Something removed all content');
                        console.trace('Stack trace for gallery clearing:');
                    }
                });
            });
            observer.observe(gallery, { childList: true, subtree: true });
            gallery.setAttribute('data-observer-set', 'true');
            console.log('üîç MutationObserver set up for gallery monitoring');
        }
        
        // Debug: Monitor if gallery gets cleared/overwritten
        setTimeout(() => {
            const checkGallery = document.getElementById('themeGallery');
            if (checkGallery && checkGallery.innerHTML.trim() === '') {
                console.error('üö® Gallery was cleared after rendering!');
            } else if (checkGallery) {
                console.log('‚úÖ Gallery still has content after 1 second');
            }
        }, 1000);
    }
    
    renderModelsTable() {
        console.log('üîç Rendering models table with', this.models.length, 'models');
        const tbody = document.getElementById('modelsTableBody');
        
        if (!tbody) {
            console.error('‚ùå modelsTableBody element not found!');
            return;
        }
        
        tbody.innerHTML = this.models.map(model => {
            const theme = model.theme_set_id ? this.themes.find(t => t.id === model.theme_set_id) : null;
            const statusClass = theme ? 'status-assigned' : 'status-unassigned';
            const statusText = theme ? 'Assigned' : 'Unassigned';
            
            return `
                <tr>
                    <td>
                        <div class="d-flex align-items-center">
                            <div class="avatar-sm bg-primary rounded-circle d-flex align-items-center justify-content-center me-3">
                                <i class="fas fa-user text-white"></i>
                            </div>
                            <div>
                                <div class="fw-semibold">${model.name}</div>
                                <small class="text-muted">@${model.slug}</small>
                            </div>
                        </div>
                    </td>
                    <td>
                        ${theme ? `
                            <div class="d-flex align-items-center">
                                <div class="theme-color-preview" style="background-color: ${theme.primaryColor}"></div>
                                <span>${theme.name}</span>
                            </div>
                        ` : '<span class="text-muted">No theme assigned</span>'}
                    </td>
                    <td>
                        <span class="model-status-badge ${statusClass}">${statusText}</span>
                    </td>
                    <td>
                        <small class="text-muted">${new Date().toLocaleDateString()}</small>
                    </td>
                    <td>
                        <div class="btn-group btn-group-sm">
                            <button class="btn btn-outline-primary" onclick="window.themeManager.assignTheme(${model.id})">
                                <i class="fas fa-palette"></i>
                            </button>
                            ${theme ? `
                                <button class="btn btn-outline-info" onclick="window.themeManager.previewModelTheme(${model.id})">
                                    <i class="fas fa-eye"></i>
                                </button>
                            ` : ''}
                        </div>
                    </td>
                </tr>
            `;
        }).join('');
    }
    
    async selectTheme(themeId) {
        this.selectedTheme = themeId;

        // Get model slug from URL or window object
        const modelSlug = window.location.pathname.split('/')[1];

        if (!modelSlug) {
            console.error('Cannot determine model slug');
            return;
        }

        // Update UI immediately
        document.querySelectorAll('.theme-card').forEach(card => {
            card.classList.remove('selected');
        });
        if (event && event.currentTarget) {
            event.currentTarget.classList.add('selected');
        }

        // Save theme selection to database
        try {
            const response = await fetch(`/api/admin/themes/${themeId}/apply?model_slug=${modelSlug}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                }
            });

            if (response.ok) {
                const result = await response.json();
                console.log('‚úÖ Theme saved:', result);

                // Show success notification
                const notification = document.createElement('div');
                notification.className = 'alert alert-success position-fixed top-0 start-50 translate-middle-x mt-3';
                notification.style.zIndex = '9999';
                notification.innerHTML = `<i class="fas fa-check-circle me-2"></i>Theme successfully applied!`;
                document.body.appendChild(notification);

                setTimeout(() => notification.remove(), 3000);
            } else {
                console.error('Failed to save theme:', response.statusText);
            }
        } catch (error) {
            console.error('Error saving theme:', error);
        }
    }
    
    assignTheme(modelId) {
        this.selectedModel = this.models.find(m => m.id === modelId);
        document.getElementById('assignmentModelId').value = modelId;
        document.getElementById('assignmentModelName').textContent = this.selectedModel.name;
        
        // Set current theme if exists
        if (this.selectedModel.theme_set_id) {
            document.getElementById('assignmentTheme').value = this.selectedModel.theme_set_id;
            this.updateThemePreviewCard(this.selectedModel.theme_set_id);
        }
        
        new bootstrap.Modal(document.getElementById('themeAssignmentModal')).show();
    }
    
    updateThemePreviewCard(themeId) {
        const theme = this.themes.find(t => t.id === themeId);
        const previewCard = document.getElementById('themePreviewCard');
        
        if (theme) {
            previewCard.innerHTML = `
                <div class="d-flex align-items-center">
                    <div class="theme-color-preview" style="background-color: ${theme.primaryColor}"></div>
                    <div class="theme-color-preview" style="background-color: ${theme.accentColor}"></div>
                    <div class="ms-2">
                        <div class="fw-semibold">${theme.name}</div>
                        <small class="text-muted">${theme.description}</small>
                    </div>
                </div>
            `;
        } else {
            previewCard.innerHTML = '<p class="text-muted mb-0">Select a theme to see preview</p>';
        }
    }
    
    async saveThemeAssignment() {
        const modelId = document.getElementById('assignmentModelId').value;
        const themeId = document.getElementById('assignmentTheme').value;
        
        if (!themeId) {
            alert('Please select a theme');
            return;
        }
        
        try {
            console.log('üíæ Saving theme assignment:', { modelId, themeId });
            
            // Send PUT request to save theme assignment
            const response = await sysFetch(`/api/theme-management/models/${modelId}/theme`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    theme_id: themeId, // This should be the theme slug for the API
                    primary_color: document.getElementById('primaryColor')?.value,
                    accent_color: document.getElementById('accentColor')?.value
                })
            });
            
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
            
            const result = await response.json();
            console.log('‚úÖ Theme assignment saved:', result);
            
            // Update model in local data with numeric theme_set_id
            const model = this.models.find(m => m.id == modelId);
            if (model) {
                // Map theme names to IDs (matching server-side mapping)
                const themeMap = {
                    'basic': 1,
                    'glamour': 2,
                    'luxury': 3,
                    'modern': 4,
                    'dark': 5
                };
                model.theme_set_id = themeMap[themeId];
                model.theme_name = themeId;
            }
            
            // Re-render tables
            this.renderThemeGallery();
            this.renderModelsTable();
            
            // Update assigned models count
            document.getElementById('assignedModels').textContent = 
                this.models.filter(m => m.theme_set_id).length;
            
            // Close modal
            bootstrap.Modal.getInstance(document.getElementById('themeAssignmentModal')).hide();
            
            // Show success message
            this.showNotification('Theme assigned successfully and saved to database!', 'success');
            
        } catch (error) {
            console.error('‚ùå Error assigning theme:', error);
            this.showNotification(`Error assigning theme: ${error.message}`, 'error');
        }
    }
    
    showThemePreview(preselectSlug) {
        // Setup theme preview list
        const previewList = document.getElementById('themePreviewList');
        previewList.innerHTML = this.themes.map(theme => `
            <a href="#" class="list-group-item list-group-item-action" 
               onclick="window.themeManager.loadThemePreview('${theme.previewUrl}', '${theme.name}')">
                <div class="d-flex align-items-center">
                    <div class="theme-color-preview" style="background-color: ${theme.primaryColor}"></div>
                    <div>
                        <div class="fw-semibold">${theme.name}</div>
                        <small class="text-muted">${theme.description}</small>
                    </div>
                </div>
            </a>
        `).join('');
        
        // Load requested or first theme by default
        const selected = preselectSlug ? this.themes.find(t => t.slug === preselectSlug) : this.themes[0];
        if (selected) this.loadThemePreview(selected.previewUrl, selected.name);
        
        new bootstrap.Modal(document.getElementById('themePreviewModal')).show();
    }

    openPreview(slug) {
        // Open preview modal preloaded with the specified theme
        this.showThemePreview(slug);
    }
    
    loadThemePreview(url, themeName) {
        document.getElementById('themePreviewFrame').src = url;
        document.querySelector('#themePreviewModal .modal-title').innerHTML = 
            `<i class="fas fa-eye me-2"></i>${themeName} Theme Preview`;
    }
    
    previewModelTheme(modelId) {
        const model = this.models.find(m => m.id === modelId);
        if (!model || !model.theme_set_id) {
            this.showNotification('No theme assigned to this model', 'warning');
            return;
        }
        
        const theme = this.themes.find(t => t.id === model.theme_set_id);
        if (!theme) {
            this.showNotification('Theme not found', 'error');
            return;
        }
        
        // Construct preview URL for the model's assigned theme
        const previewUrl = `${theme.previewUrl}?model=${model.slug}`;
        
        // Load the preview
        document.getElementById('themePreviewFrame').src = previewUrl;
        document.querySelector('#themePreviewModal .modal-title').innerHTML = 
            `<i class="fas fa-eye me-2"></i>${model.name} - ${theme.name} Theme Preview`;
        
        new bootstrap.Modal(document.getElementById('themePreviewModal')).show();
    }
    
    async loadGalleryProfiles() {
        try {
            console.log('üñºÔ∏è Loading gallery profiles...');
            const response = await sysFetch('/api/universal-gallery-profiles/profiles');
            if (response.ok) {
                this.galleryProfiles = await response.json();
                console.log('‚úÖ Loaded', this.galleryProfiles.length, 'gallery profiles');
                this.renderThemeGalleryAssignmentMatrix();
            } else {
                throw new Error('Failed to load gallery profiles');
            }
        } catch (error) {
            console.error('‚ùå Error loading gallery profiles:', error);
            this.galleryProfiles = [];
            this.renderThemeGalleryAssignmentError();
        }
    }
    
    async loadThemeGalleryAssignments() {
        try {
            console.log('üîó Loading theme gallery assignments...');
            const response = await sysFetch('/api/theme-management/gallery-assignments');
            if (response.ok) {
                const rawAssignments = await response.json();
                // Convert to support multiple profiles per theme
                this.themeGalleryAssignments = {};
                Object.keys(rawAssignments).forEach(themeId => {
                    if (Array.isArray(rawAssignments[themeId])) {
                        this.themeGalleryAssignments[themeId] = rawAssignments[themeId];
                    } else {
                        // Convert single assignment to array format
                        this.themeGalleryAssignments[themeId] = [rawAssignments[themeId]];
                    }
                });
                console.log('‚úÖ Loaded theme gallery assignments');
            } else {
                console.log('‚ö†Ô∏è No theme gallery assignments found, using empty');
                this.themeGalleryAssignments = {};
            }
        } catch (error) {
            console.error('‚ùå Error loading theme gallery assignments:', error);
            this.themeGalleryAssignments = {};
        }
    }
    
    async renderThemeGalleryAssignmentMatrix() {
        const container = document.getElementById('themeGalleryAssignmentMatrix');
        if (!container) return;
        
        // Load assignments if not already loaded
        if (!this.themeGalleryAssignments) {
            await this.loadThemeGalleryAssignments();
        }
        
        if (!this.galleryProfiles || this.galleryProfiles.length === 0) {
            container.innerHTML = `
                <div class="text-center py-5">
                    <i class="fas fa-exclamation-triangle fs-1 text-warning mb-3"></i>
                    <h5 class="text-warning">No Gallery Profiles Found</h5>
                    <p class="text-muted mb-3">You need to create gallery profiles first before assigning them to themes</p>
                    <button class="btn btn-primary" onclick="loadSection('universal-gallery-admin')">
                        <i class="fas fa-plus me-2"></i>Create Gallery Profiles
                    </button>
                </div>
            `;
            return;
        }
        
        let html = `
            <div class="row mb-3">
                <div class="col-12">
                    <button class="btn btn-success" onclick="window.themeManager.saveAllGalleryAssignments()">
                        <i class="fas fa-save me-2"></i>Save All Gallery Assignments
                    </button>
                </div>
            </div>
        `;
        
        // Render each theme as a card with multiple gallery profile assignments
        this.themes.forEach(theme => {
            const assignedProfiles = this.themeGalleryAssignments[theme.id] || [];
            
            html += `
                <div class="card mb-4 border-0 shadow-sm">
                    <div class="card-header bg-light">
                        <div class="row align-items-center">
                            <div class="col">
                                <div class="d-flex align-items-center">
                                    <div class="theme-color-preview me-3" style="background-color: ${theme.primaryColor}"></div>
                                    <div>
                                        <h5 class="mb-1 fw-semibold">${this.escapeHtml(theme.name)}</h5>
                                        <p class="mb-0 text-muted">${this.escapeHtml(theme.description)}</p>
                                    </div>
                                </div>
                            </div>
                            <div class="col-auto">
                                <button class="btn btn-primary btn-sm" onclick="window.themeManager.addGalleryToTheme(${theme.id})">
                                    <i class="fas fa-plus me-1"></i>Add Gallery Profile
                                </button>
                            </div>
                        </div>
                    </div>
                    <div class="card-body">
                        <div id="themeGalleries_${theme.id}">
                            ${assignedProfiles.length > 0 ? `
                                <div class="row g-3">
                                    ${assignedProfiles.map(assignment => {
                                        const profileInfo = this.galleryProfiles.find(p => p.id === assignment.gallery_profile_id);
                                        return profileInfo ? `
                                            <div class="col-md-6 col-lg-4">
                                                <div class="card border h-100">
                                                    <div class="card-body">
                                                        <div class="d-flex justify-content-between align-items-start mb-2">
                                                            <h6 class="card-title mb-0">${this.escapeHtml(profileInfo.profile_display_name)}</h6>
                                                            <button class="btn btn-outline-danger btn-sm" 
                                                                    onclick="window.themeManager.removeGalleryFromTheme(${theme.id}, ${profileInfo.id})">
                                                                <i class="fas fa-times"></i>
                                                            </button>
                                                        </div>
                                                        <div class="d-flex flex-wrap gap-1 mb-2">
                                                            <span class="badge bg-primary">${profileInfo.layout_type}</span>
                                                            <span class="badge bg-secondary">${profileInfo.grid_columns_desktop || profileInfo.carousel_visible_items || 'N/A'} items</span>
                                                            <span class="badge bg-info">${profileInfo.images_per_page} per page</span>
                                                        </div>
                                                        <div class="d-flex flex-wrap gap-1 mb-3">
                                                            ${profileInfo.lightbox_enabled ? '<span class="badge bg-success">Lightbox</span>' : ''}
                                                            ${profileInfo.enable_search ? '<span class="badge bg-warning text-dark">Search</span>' : ''}
                                                            ${profileInfo.enable_sorting ? '<span class="badge bg-info text-dark">Sort</span>' : ''}
                                                        </div>
                                                        <div class="d-flex gap-1">
                                                            <button class="btn btn-outline-info btn-sm flex-fill" 
                                                                    onclick="window.themeManager.previewThemeGallery(${theme.id}, ${profileInfo.id})">
                                                                <i class="fas fa-eye me-1"></i>Preview
                                                            </button>
                                                            <div class="form-check form-switch d-flex align-items-center ms-2">
                                                                <input class="form-check-input" type="checkbox" 
                                                                       id="default_${theme.id}_${profileInfo.id}"
                                                                       ${assignment.is_default ? 'checked' : ''}
                                                                       onchange="window.themeManager.toggleDefaultGallery(${theme.id}, ${profileInfo.id}, this.checked)">
                                                                <label class="form-check-label ms-1 small" for="default_${theme.id}_${profileInfo.id}">
                                                                    Default
                                                                </label>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        ` : '';
                                    }).join('')}
                                </div>
                            ` : `
                                <div class="text-center py-4">
                                    <i class="fas fa-images fs-2 text-muted mb-3"></i>
                                    <p class="text-muted mb-3">No gallery profiles assigned to this theme</p>
                                    <button class="btn btn-outline-primary" onclick="window.themeManager.addGalleryToTheme(${theme.id})">
                                        <i class="fas fa-plus me-2"></i>Assign First Gallery Profile
                                    </button>
                                </div>
                            `}
                        </div>
                    </div>
                </div>
            `;
        });
        
        container.innerHTML = html;
    }
    
    renderThemeGalleryAssignmentError() {
        const container = document.getElementById('themeGalleryAssignmentMatrix');
        if (!container) return;
        
        container.innerHTML = `
            <div class="text-center py-5">
                <i class="fas fa-exclamation-circle fs-1 text-danger mb-3"></i>
                <h5 class="text-danger">Failed to Load Gallery Profiles</h5>
                <p class="text-muted mb-3">There was an error loading the gallery profiles</p>
                <button class="btn btn-outline-primary" onclick="window.themeManager.loadGalleryProfiles()">
                    <i class="fas fa-refresh me-2"></i>Try Again
                </button>
            </div>
        `;
    }
    
    async addGalleryToTheme(themeId) {
        // Show modal with available gallery profiles
        const assignedProfiles = this.themeGalleryAssignments[themeId] || [];
        const assignedIds = assignedProfiles.map(a => a.gallery_profile_id);
        const availableProfiles = this.galleryProfiles.filter(p => !assignedIds.includes(p.id));
        
        if (availableProfiles.length === 0) {
            this.showNotification('All gallery profiles are already assigned to this theme', 'warning');
            return;
        }
        
        const theme = this.themes.find(t => t.id === themeId);
        
        let html = `
            <div class="modal fade" id="addGalleryModal" tabindex="-1">
                <div class="modal-dialog modal-lg">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">Add Gallery Profile to ${this.escapeHtml(theme.name)}</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body">
                            <p class="text-muted mb-4">Select gallery profiles to assign to this theme:</p>
                            <div class="row g-3">
                                ${availableProfiles.map(profile => `
                                    <div class="col-md-6">
                                        <div class="card border">
                                            <div class="card-body">
                                                <div class="form-check">
                                                    <input class="form-check-input" type="checkbox" 
                                                           id="addProfile_${profile.id}" 
                                                           value="${profile.id}">
                                                    <label class="form-check-label fw-medium" for="addProfile_${profile.id}">
                                                        ${this.escapeHtml(profile.profile_display_name)}
                                                    </label>
                                                </div>
                                                <small class="text-muted">${profile.profile_description || 'No description'}</small>
                                                <div class="mt-2">
                                                    <span class="badge bg-primary">${profile.layout_type}</span>
                                                    <span class="badge bg-secondary">${profile.grid_columns_desktop || profile.carousel_visible_items || 'N/A'} items</span>
                                                    <span class="badge bg-info">${profile.images_per_page} per page</span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                            <button type="button" class="btn btn-primary" onclick="window.themeManager.confirmAddGalleriesToTheme(${themeId})">
                                <i class="fas fa-plus me-2"></i>Add Selected Profiles
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        `;
        
        // Remove existing modal if any
        const existingModal = document.getElementById('addGalleryModal');
        if (existingModal) existingModal.remove();
        
        // Add new modal to page
        document.body.insertAdjacentHTML('beforeend', html);
        
        // Show modal
        const modal = new bootstrap.Modal(document.getElementById('addGalleryModal'));
        modal.show();
    }
    
    async confirmAddGalleriesToTheme(themeId) {
        const checkboxes = document.querySelectorAll('#addGalleryModal input[type="checkbox"]:checked');
        const selectedProfiles = Array.from(checkboxes).map(cb => parseInt(cb.value));
        
        if (selectedProfiles.length === 0) {
            this.showNotification('Please select at least one gallery profile', 'warning');
            return;
        }
        
        try {
            // Call new API endpoint with all selected profiles
            const response = await sysFetch('/api/theme-management/gallery-assignments/add', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    theme_id: themeId,
                    gallery_profile_ids: selectedProfiles
                })
            });
            
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
            
            // Close modal
            bootstrap.Modal.getInstance(document.getElementById('addGalleryModal')).hide();
            
            // Refresh the display
            await this.loadThemeGalleryAssignments();
            this.renderThemeGalleryAssignmentMatrix();
            
            this.showNotification(`Successfully added ${selectedProfiles.length} gallery profile(s) to theme`, 'success');
            
        } catch (error) {
            console.error('‚ùå Error adding galleries to theme:', error);
            this.showNotification('Error adding gallery profiles', 'error');
        }
    }
    
    
    async removeGalleryFromTheme(themeId, profileId) {
        if (confirm('Remove this gallery profile from the theme?')) {
            try {
                const response = await sysFetch('/api/theme-management/gallery-assignments/remove', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        theme_id: themeId,
                        gallery_profile_id: profileId
                    })
                });
                
                if (response.ok) {
                    // Update local data
                    if (this.themeGalleryAssignments[themeId]) {
                        this.themeGalleryAssignments[themeId] = this.themeGalleryAssignments[themeId].filter(
                            a => a.gallery_profile_id !== profileId
                        );
                    }
                    
                    // Re-render the matrix
                    this.renderThemeGalleryAssignmentMatrix();
                    
                    this.showNotification('Gallery profile removed successfully!', 'success');
                } else {
                    throw new Error('Failed to remove gallery profile');
                }
            } catch (error) {
                console.error('‚ùå Error removing gallery from theme:', error);
                this.showNotification('Error removing gallery profile', 'error');
            }
        }
    }
    
    async toggleDefaultGallery(themeId, profileId, isDefault) {
        try {
            const response = await sysFetch('/api/theme-management/gallery-assignments/default', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    theme_id: themeId,
                    gallery_profile_id: profileId,
                    is_default: isDefault
                })
            });
            
            if (response.ok) {
                // Update local data
                if (this.themeGalleryAssignments[themeId]) {
                    this.themeGalleryAssignments[themeId].forEach(assignment => {
                        if (assignment.gallery_profile_id === profileId) {
                            assignment.is_default = isDefault;
                        } else if (isDefault) {
                            // Only one can be default, unset others
                            assignment.is_default = false;
                        }
                    });
                }
                
                // Re-render to update other checkboxes
                this.renderThemeGalleryAssignmentMatrix();
                
                this.showNotification(`Gallery profile ${isDefault ? 'set as' : 'removed from'} default`, 'success');
            } else {
                throw new Error('Failed to update default status');
            }
        } catch (error) {
            console.error('‚ùå Error toggling default gallery:', error);
            this.showNotification('Error updating default status', 'error');
            // Re-render to reset checkbox
            this.renderThemeGalleryAssignmentMatrix();
        }
    }
    
    async resetThemeGalleryAssignment(themeId) {
        if (confirm('Remove gallery profile assignment from this theme?')) {
            await this.updateThemeGalleryAssignment(themeId, null);
        }
    }
    
    async previewThemeGallery(themeId) {
        const theme = this.themes.find(t => t.id === themeId);
        const assignment = this.themeGalleryAssignments[themeId];
        
        if (!theme || !assignment) {
            this.showNotification('No gallery profile assigned to preview', 'warning');
            return;
        }
        
        const previewUrl = `${theme.previewUrl}&gallery_preview=1`;
        window.open(previewUrl, '_blank');
    }
    
    async saveAllGalleryAssignments() {
        try {
            console.log('üíæ Saving all theme gallery assignments...');
            
            const assignments = [];
            this.themes.forEach(theme => {
                const select = document.getElementById(`gallerySelect_${theme.id}`);
                if (select && select.value) {
                    assignments.push({
                        theme_id: theme.id,
                        gallery_profile_id: parseInt(select.value)
                    });
                }
            });
            
            const response = await sysFetch('/api/theme-management/gallery-assignments/bulk', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ assignments })
            });
            
            if (response.ok) {
                this.showNotification(`Successfully saved ${assignments.length} gallery assignments!`, 'success');
                await this.loadThemeGalleryAssignments();
                this.renderThemeGalleryAssignmentMatrix();
            } else {
                throw new Error('Failed to save assignments');
            }
        } catch (error) {
            console.error('‚ùå Error saving all gallery assignments:', error);
            this.showNotification('Error saving gallery assignments', 'error');
        }
    }
    
    escapeHtml(unsafe) {
        if (typeof unsafe !== 'string') return unsafe;
        return unsafe
            .replace(/&/g, "&amp;")
            .replace(/</g, "&lt;")
            .replace(/>/g, "&gt;")
            .replace(/"/g, "&quot;")
            .replace(/'/g, "&#039;");
    }
    
    setupEventListeners() {
        // Theme selection change
        document.getElementById('assignmentTheme').addEventListener('change', (e) => {
            this.updateThemePreviewCard(e.target.value);
        });
        
        // Custom colors toggle
        document.getElementById('enableCustomColors').addEventListener('change', (e) => {
            const section = document.getElementById('customColorSection');
            if (e.target.checked) {
                section.classList.remove('d-none');
            } else {
                section.classList.add('d-none');
            }
        });
    }
    
    editThemeCSS(themeId, themeName) {
        console.log('üé® Opening CSS editor for theme:', themeName, 'ID:', themeId);
        
        // Store current theme being edited
        this.currentEditingTheme = { id: themeId, name: themeName };
        
        // Update modal title
        document.getElementById('themeCSSEditorTitle').textContent = `Edit CSS: ${themeName}`;
        
        // Load current CSS for this theme
        this.loadThemeCSS(themeId);
        
        // Show the modal
        new bootstrap.Modal(document.getElementById('themeCSSEditorModal')).show();
    }
    
    async loadThemeCSS(themeId) {
        try {
            // Show loading state
            document.getElementById('cssEditor').value = '/* Loading theme CSS... */';
            
            const response = await sysFetch(`/api/theme-management/themes/${themeId}/css`);
            if (response.ok) {
                const result = await response.json();
                document.getElementById('cssEditor').value = result.css || this.getDefaultThemeCSS();
            } else {
                // Fallback to default CSS template
                document.getElementById('cssEditor').value = this.getDefaultThemeCSS();
            }
        } catch (error) {
            console.error('Error loading theme CSS:', error);
            document.getElementById('cssEditor').value = this.getDefaultThemeCSS();
        }
    }
    
    getDefaultThemeCSS() {
        return `/* Theme-specific CSS customizations */

:root {
    /* Primary color scheme */
    --theme-primary: #3B82F6;
    --theme-secondary: #10B981;
    --theme-accent: #F59E0B;
    
    /* Gallery-specific variables */
    --gallery-item-border-radius: 8px;
    --gallery-hover-transform: translateY(-2px);
    --gallery-transition: all 0.3s ease;
    
    /* Layout spacing */
    --gallery-gap: 1.5rem;
    --gallery-item-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
}

/* Gallery container styles */
.gallery-container {
    /* Theme-specific gallery container styles */
}

/* Gallery item styles */
.gallery-item {
    border-radius: var(--gallery-item-border-radius);
    transition: var(--gallery-transition);
    box-shadow: var(--gallery-item-shadow);
}

.gallery-item:hover {
    transform: var(--gallery-hover-transform);
}

/* Lightbox customizations */
.lightbox-overlay {
    /* Theme-specific lightbox styles */
}

/* Carousel customizations */
.carousel-container {
    /* Theme-specific carousel styles */
}`;
    }
    
    async saveThemeCSS() {
        const css = document.getElementById('cssEditor').value;
        const themeId = this.currentEditingTheme.id;
        
        try {
            const response = await sysFetch(`/api/theme-management/themes/${themeId}/css`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ css })
            });
            
            if (response.ok) {
                this.showNotification('Theme CSS saved successfully!', 'success');
                bootstrap.Modal.getInstance(document.getElementById('themeCSSEditorModal')).hide();
            } else {
                throw new Error('Failed to save CSS');
            }
        } catch (error) {
            console.error('Error saving theme CSS:', error);
            this.showNotification('Error saving theme CSS', 'error');
        }
    }
    
    previewThemeCSS() {
        const css = document.getElementById('cssEditor').value;
        console.log('üëÅÔ∏è Previewing CSS changes...');
        
        // Create a temporary style element for preview
        let previewStyle = document.getElementById('cssPreviewStyle');
        if (!previewStyle) {
            previewStyle = document.createElement('style');
            previewStyle.id = 'cssPreviewStyle';
            document.head.appendChild(previewStyle);
        }
        
        previewStyle.textContent = css;
        this.showNotification('CSS preview applied! Check the page styling.', 'info');
    }
    
    resetThemeCSS() {
        if (confirm('Reset CSS to default template? This will lose current changes.')) {
            document.getElementById('cssEditor').value = this.getDefaultThemeCSS();
            this.showNotification('CSS reset to default template', 'info');
        }
    }
    
    formatCSS() {
        const css = document.getElementById('cssEditor').value;
        // Basic CSS formatting - add proper indentation and spacing
        const formatted = css
            .replace(/\{/g, ' {\n    ')
            .replace(/\}/g, '\n}\n')
            .replace(/;/g, ';\n    ')
            .replace(/\n\s*\n/g, '\n')
            .replace(/\n    \}/g, '\n}');
        
        document.getElementById('cssEditor').value = formatted;
        this.showNotification('CSS formatted', 'success');
    }
    
    showNotification(message, type = 'info') {
        // Simple notification - can be enhanced with a proper notification system
        const alertClass = type === 'success' ? 'alert-success' : 
                          type === 'error' ? 'alert-danger' : 'alert-info';
        
        const notification = document.createElement('div');
        notification.className = `alert ${alertClass} alert-dismissible fade show position-fixed`;
        notification.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
        notification.innerHTML = `
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        `;
        
        document.body.appendChild(notification);
        
        setTimeout(() => {
            if (notification.parentNode) {
                notification.parentNode.removeChild(notification);
            }
        }, 5000);
    }
}

// Global functions for onclick handlers
function showThemePreview() {
    window.themeManager.showThemePreview();
}

async function assignPreviewTheme() {
    try {
        // Get theme ID from preview URL
        const previewFrame = document.getElementById('themePreviewFrame');
        const themeId = new URL(previewFrame.src).searchParams.get('preview_theme');
        
        if (!themeId) {
            alert('No theme selected');
            return;
        }
        
        // Default to Model Example (ID 39) - this is what's being previewed
        const modelId = 39;
        
        if (!confirm(`Assign theme ${themeId} to this model?`)) {
            return;
        }
        
        // Update database
        const response = await fetch(`/api/theme-management/models/${modelId}/theme`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ theme_set_id: parseInt(themeId) })
        });
        
        if (response.ok) {
            alert('Theme assigned successfully!');
            bootstrap.Modal.getInstance(document.getElementById('themePreviewModal')).hide();
        } else {
            alert('Error assigning theme');
        }
        
    } catch (error) {
        console.error('Error:', error);
        alert('Error assigning theme');
    }
}

function filterModels() {
    // Implementation for model search
    console.log('Filter models');
}

function filterByTheme() {
    // Implementation for theme filter
    console.log('Filter by theme');
}

    // ==========================================
    // COLOR PALETTE MANAGEMENT METHODS
    // ==========================================
    
    async initColorPalettes() {
        console.log('üé® Initializing color palette management...');
        this.currentModelId = 39; // Model Example for demonstration
        this.currentColors = null;
        this.availablePalettes = [];
        this.editingPalette = null;
        
        await this.loadCurrentModelColors();
        await this.loadAvailablePalettes();
        this.renderCurrentThemeInfo();
        this.renderPaletteGrid();
    }
    
    async loadCurrentModelColors() {
        try {
            const response = await sysFetch(`/api/models/${this.currentModelId}/colors`);
            if (response.ok) {
                this.currentColors = await response.json();
                console.log('‚úÖ Loaded current model colors:', this.currentColors);
            } else {
                throw new Error('Failed to load current colors');
            }
        } catch (error) {
            console.error('‚ùå Error loading current colors:', error);
            this.showColorError('Failed to load current color scheme');
        }
    }
    
    async loadAvailablePalettes() {
        try {
            const response = await sysFetch(`/api/models/${this.currentModelId}/palettes`);
            if (response.ok) {
                const result = await response.json();
                this.availablePalettes = result.palettes;
                console.log('‚úÖ Loaded available palettes:', this.availablePalettes.length);
            } else {
                throw new Error('Failed to load available palettes');
            }
        } catch (error) {
            console.error('‚ùå Error loading palettes:', error);
            this.showColorError('Failed to load available color palettes');
        }
    }
    
    renderCurrentThemeInfo() {
        if (!this.currentColors) return;
        
        document.getElementById('currentThemeName').textContent = this.currentColors.theme.display_name;
        document.getElementById('currentPaletteName').textContent = this.currentColors.palette.display_name;
        
        const customBadge = document.getElementById('customPaletteBadge');
        if (this.currentColors.palette.is_custom) {
            customBadge.style.display = 'inline';
        } else {
            customBadge.style.display = 'none';
        }
    }
    
    renderPaletteGrid() {
        const container = document.getElementById('paletteGrid');
        if (!container || !this.availablePalettes.length) {
            if (container) {
                container.innerHTML = '<div class="col-12 text-center py-4"><p class="text-muted">No color palettes available</p></div>';
            }
            return;
        }
        
        const paletteCards = this.availablePalettes.map(palette => {
            const isActive = this.currentColors && this.currentColors.palette.id === palette.id;
            const previewColors = Object.values(palette.preview_colors).slice(0, 6);
            
            return `
                <div class="col-lg-4 col-md-6 mb-3">
                    <div class="card h-100 ${isActive ? 'border-primary' : 'border-light'}" style="cursor: pointer;" 
                         onclick="window.themeManager.selectPalette(${palette.id})">
                        <div class="card-header bg-light d-flex justify-content-between align-items-center">
                            <h6 class="mb-0 fw-bold">${this.escapeHtml(palette.display_name)}</h6>
                            ${isActive ? '<span class="badge bg-primary">Active</span>' : ''}
                            ${palette.is_custom ? '<span class="badge bg-secondary">Custom</span>' : '<span class="badge bg-success">System</span>'}
                        </div>
                        <div class="card-body">
                            <div class="color-preview-strip d-flex mb-3">
                                ${previewColors.map(color => `
                                    <div class="theme-color-preview flex-fill me-1" 
                                         style="background-color: ${color}; height: 40px; border-radius: 4px;" 
                                         title="${color}"></div>
                                `).join('')}
                            </div>
                            <div class="d-flex gap-2">
                                <button class="btn btn-sm btn-outline-primary flex-fill" 
                                        onclick="event.stopPropagation(); window.themeManager.selectPalette(${palette.id})">
                                    ${isActive ? '<i class="fas fa-check me-1"></i>Current' : '<i class="fas fa-paint-brush me-1"></i>Use This'}
                                </button>
                                <button class="btn btn-sm btn-outline-secondary" 
                                        onclick="event.stopPropagation(); window.themeManager.editPalette(${palette.id})">
                                    <i class="fas fa-edit"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }).join('');
        
        container.innerHTML = paletteCards;
    }
    
    async selectPalette(paletteId) {
        try {
            if (this.currentColors && this.currentColors.palette.id === paletteId) {
                console.log('Palette already active');
                return;
            }
            
            console.log('üé® Switching to palette:', paletteId);
            
            const response = await sysFetch(`/api/models/${this.currentModelId}/palette`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ palette_id: paletteId })
            });
            
            if (response.ok) {
                console.log('‚úÖ Palette switched successfully');
                await this.loadCurrentModelColors();
                this.renderCurrentThemeInfo();
                this.renderPaletteGrid();
                this.showColorSuccess('Color palette changed successfully');
            } else {
                throw new Error('Failed to switch palette');
            }
        } catch (error) {
            console.error('‚ùå Error switching palette:', error);
            this.showColorError('Failed to switch color palette');
        }
    }
    
    async editPalette(paletteId) {
        try {
            console.log('‚úèÔ∏è Editing palette:', paletteId);
            
            // Find the palette to edit
            const palette = this.availablePalettes.find(p => p.id === paletteId);
            if (!palette) {
                throw new Error('Palette not found');
            }
            
            // If it's a system palette, we need to create a custom one based on it first
            if (!palette.is_custom) {
                const confirmed = confirm(`This will create a custom version of "${palette.display_name}" that you can edit. Continue?`);
                if (!confirmed) return;
                
                // Select this palette first, then create a custom version
                await this.selectPalette(paletteId);
                await this.createCustomPalette(palette.display_name + ' (Custom)');
                return;
            }
            
            // Load full color data for the palette
            const response = await sysFetch(`/api/models/${this.currentModelId}/colors`);
            if (response.ok) {
                const colorData = await response.json();
                this.showColorEditor(palette, colorData.colors);
            } else {
                throw new Error('Failed to load palette colors');
            }
            
        } catch (error) {
            console.error('‚ùå Error editing palette:', error);
            this.showColorError('Failed to edit color palette');
        }
    }
    
    showColorEditor(palette, colors) {
        this.editingPalette = palette;
        
        // Show the color editor section
        const editor = document.getElementById('colorTokenEditor');
        editor.style.display = 'block';
        
        // Update editor title
        document.getElementById('editingPaletteName').textContent = palette.display_name;
        
        // Populate color tokens
        const tokenGrid = document.getElementById('colorTokenGrid');
        const tokenGroups = this.groupColorTokens(colors);
        
        let html = '';
        Object.entries(tokenGroups).forEach(([groupName, tokens]) => {
            html += `
                <div class="col-12 mb-4">
                    <h6 class="fw-bold text-primary mb-3">
                        <i class="fas fa-palette me-2"></i>${groupName}
                    </h6>
                    <div class="row g-3">
                        ${tokens.map(([tokenName, tokenValue, tokenDescription]) => `
                            <div class="col-lg-3 col-md-4 col-sm-6">
                                <div class="card border hover-shadow h-100">
                                    <div class="card-body p-3">
                                        <div class="d-flex align-items-start mb-2">
                                            <input type="color" class="form-control form-control-color flex-shrink-0 me-2"
                                                   value="${tokenValue}" id="token_${tokenName}"
                                                   onchange="window.themeManager.updateColorToken('${tokenName}', this.value)"
                                                   style="width: 50px; height: 50px; border-radius: 8px;">
                                            <div class="flex-grow-1 min-w-0">
                                                <label class="form-label mb-1 fw-bold" for="token_${tokenName}">${tokenName}</label>
                                                <div class="text-muted small font-monospace mb-1" style="font-size: 0.75rem;">${tokenValue}</div>
                                            </div>
                                        </div>
                                        ${tokenDescription ? `
                                            <p class="text-muted small mb-0" style="font-size: 0.7rem; line-height: 1.3;">
                                                ${tokenDescription}
                                            </p>
                                        ` : ''}
                                    </div>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
        });

        tokenGrid.innerHTML = html;
        
        // Scroll to editor
        editor.scrollIntoView({ behavior: 'smooth', block: 'start' });
    }
    
    groupColorTokens(colors) {
        // Standard 15-token palette grouping
        const groups = {
            'Brand Colors (3)': [],
            'Backgrounds & Surfaces (3)': [],
            'Text Colors (4)': [],
            'Borders (2)': [],
            'Semantic Colors (3)': []
        };

        // Define token descriptions for better UX
        const tokenDescriptions = {
            'primary': 'Main brand color (buttons, navigation)',
            'secondary': 'Secondary brand color',
            'accent': 'Highlights, links, badges',
            'background': 'Main page background',
            'surface': 'Cards, panels, modals',
            'surface-alt': 'Alternate surface (zebra rows, hover)',
            'text': 'Primary body text',
            'text-subtle': 'Muted/secondary text',
            'text-light': 'Very light text (placeholders)',
            'text-inverse': 'Text on colored backgrounds',
            'border': 'Default borders',
            'border-light': 'Subtle dividers',
            'success': 'Success states & messages',
            'danger': 'Error states & destructive actions',
            'info': 'Informational callouts'
        };

        // Sort tokens into standardized groups
        Object.entries(colors).forEach(([key, value]) => {
            const entry = [key, value, tokenDescriptions[key] || ''];

            // Brand Colors
            if (['primary', 'secondary', 'accent'].includes(key)) {
                groups['Brand Colors (3)'].push(entry);
            }
            // Backgrounds & Surfaces
            else if (['background', 'surface', 'surface-alt'].includes(key)) {
                groups['Backgrounds & Surfaces (3)'].push(entry);
            }
            // Text Colors
            else if (['text', 'text-subtle', 'text-light', 'text-inverse'].includes(key)) {
                groups['Text Colors (4)'].push(entry);
            }
            // Borders
            else if (['border', 'border-light'].includes(key)) {
                groups['Borders (2)'].push(entry);
            }
            // Semantic Colors
            else if (['success', 'danger', 'info'].includes(key)) {
                groups['Semantic Colors (3)'].push(entry);
            }
        });

        // Remove empty groups
        Object.keys(groups).forEach(key => {
            if (groups[key].length === 0) {
                delete groups[key];
            }
        });

        return groups;
    }
    
    updateColorToken(tokenName, newValue) {
        console.log(`üé® Updated ${tokenName} to ${newValue}`);
        // Update the hex value display
        const tokenInput = document.getElementById(`token_${tokenName}`);
        if (tokenInput) {
            const valueDisplay = tokenInput.closest('.card-body').querySelector('.text-muted');
            if (valueDisplay) {
                valueDisplay.textContent = newValue;
            }
        }
    }
    
    async saveColorChanges() {
        if (!this.editingPalette) {
            console.error('No palette being edited');
            return;
        }
        
        try {
            console.log('üíæ Saving color changes for palette:', this.editingPalette.id);
            
            // Collect all color values from the form
            const colorUpdates = {};
            const tokenInputs = document.querySelectorAll('#colorTokenGrid input[type="color"]');
            
            tokenInputs.forEach(input => {
                const tokenName = input.id.replace('token_', '');
                colorUpdates[tokenName] = input.value;
            });
            
            console.log('Color updates to save:', colorUpdates);
            
            const response = await sysFetch(`/api/palettes/${this.editingPalette.id}/colors`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(colorUpdates)
            });
            
            if (response.ok) {
                console.log('‚úÖ Color changes saved successfully');
                await this.loadCurrentModelColors();
                await this.loadAvailablePalettes();
                this.renderCurrentThemeInfo();
                this.renderPaletteGrid();
                this.cancelColorEditing();
                this.showColorSuccess('Color changes saved successfully');
            } else {
                throw new Error('Failed to save color changes');
            }
            
        } catch (error) {
            console.error('‚ùå Error saving color changes:', error);
            this.showColorError('Failed to save color changes');
        }
    }
    
    cancelColorEditing() {
        this.editingPalette = null;
        const editor = document.getElementById('colorTokenEditor');
        editor.style.display = 'none';
    }
    
    async createCustomPalette(name) {
        try {
            const paletteName = name || prompt('Enter a name for your custom palette:');
            if (!paletteName) return;
            
            console.log('üé® Creating custom palette:', paletteName);
            
            const response = await sysFetch(`/api/models/${this.currentModelId}/palettes/custom`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ 
                    name: paletteName,
                    color_edits: {} // Start with current colors
                })
            });
            
            if (response.ok) {
                const result = await response.json();
                console.log('‚úÖ Custom palette created:', result.palette);
                
                await this.loadCurrentModelColors();
                await this.loadAvailablePalettes();
                this.renderCurrentThemeInfo();
                this.renderPaletteGrid();
                this.showColorSuccess('Custom palette created successfully');
            } else {
                throw new Error('Failed to create custom palette');
            }
            
        } catch (error) {
            console.error('‚ùå Error creating custom palette:', error);
            this.showColorError('Failed to create custom palette');
        }
    }
    
    showColorSuccess(message) {
        // Create a temporary success alert
        const alert = document.createElement('div');
        alert.className = 'alert alert-success alert-dismissible fade show position-fixed';
        alert.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
        alert.innerHTML = `
            <i class="fas fa-check-circle me-2"></i>${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        `;
        document.body.appendChild(alert);
        setTimeout(() => alert.remove(), 5000);
    }
    
    showColorError(message) {
        // Create a temporary error alert
        const alert = document.createElement('div');
        alert.className = 'alert alert-danger alert-dismissible fade show position-fixed';
        alert.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
        alert.innerHTML = `
            <i class="fas fa-exclamation-triangle me-2"></i>${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        `;
        document.body.appendChild(alert);
        setTimeout(() => alert.remove(), 7000);
    }
} // End ThemeManagement class definition conditional

function filterByStatus() {
    // Implementation for status filter
    console.log('Filter by status');
}

function saveThemeAssignment() {
    window.themeManager.saveThemeAssignment();
}

// Global functions for color palette management
function createCustomPalette() {
    if (window.themeManager) {
        window.themeManager.createCustomPalette();
    }
}

function saveColorChanges() {
    if (window.themeManager) {
        window.themeManager.saveColorChanges();
    }
}

function cancelColorEditing() {
    if (window.themeManager) {
        window.themeManager.cancelColorEditing();
    }
}

// Initialize when component loads
if (typeof window.themeManager === 'undefined') {
    window.themeManager = null;
}

// Prevent multiple initialization attempts
let themeManagementInitialized = false;

// Function to initialize theme management
function initializeThemeManagement() {
    console.log('üé® Theme management initialization attempt...');
    
    // Check if already initialized
    if (themeManagementInitialized) {
        console.log('üîÑ Theme Management already initialized, skipping...');
        return;
    }
    
    // Check if required DOM elements exist
    const themeSection = document.getElementById('theme-management-section');
    const themeGallery = document.getElementById('themeGallery');
    
    if (!themeSection && !themeGallery) {
        console.log('‚è≥ Theme management DOM elements not ready yet, skipping...');
        return;
    }
    
    if (!window.themeManager) {
        console.log('üé® Initializing Theme Management...');
        themeManagementInitialized = true;
        window.themeManager = new window.ThemeManagement();
        
        // Activate the themes tab programmatically using Bootstrap's Tab API
        setTimeout(() => {
            const themesTab = document.querySelector('#themes-tab');
            if (themesTab) {
                // Use Bootstrap's Tab API to properly activate the tab
                const tab = new bootstrap.Tab(themesTab);
                tab.show();
                console.log('üîß Activated themes tab using Bootstrap API');
                
                // Also force the pane to be visible as fallback
                const themesPane = document.getElementById('themes-pane');
                if (themesPane) {
                    themesPane.style.display = 'block';
                    themesPane.style.opacity = '1';
                    themesPane.style.visibility = 'visible';
                    console.log('üîß Forced themes pane visibility as fallback');
                }
            }
        }, 100);
    } else {
        console.log('üîÑ Theme manager instance already exists, skipping...');
        themeManagementInitialized = true;
    }
}

// Debug function to manually re-render themes
window.debugRenderThemes = function() {
    if (window.themeManager && window.themeManager.themes) {
        console.log('üîß Manual theme gallery render triggered');
        window.themeManager.renderThemeGallery();
    } else {
        console.log('‚ùå Theme manager not initialized or no themes loaded');
    }
};

// Debug function to check gallery state
window.debugGalleryState = function() {
    const gallery = document.getElementById('themeGallery');
    if (gallery) {
        console.log('Gallery innerHTML length:', gallery.innerHTML.length);
        console.log('Gallery children count:', gallery.children.length);
        console.log('Gallery content preview:', gallery.innerHTML.substring(0, 200) + '...');
    } else {
        console.log('‚ùå Gallery element not found');
    }
};

// Reset function for debugging
window.resetThemeManagement = function() {
    console.log('üîÑ Resetting theme management...');
    themeManagementInitialized = false;
    window.themeManager = null;
    setTimeout(initializeThemeManagement, 100);
};

// Single initialization attempt - only when this script loads  
// The main dashboard will call initializeThemeManagement when needed
// Updated: Fixed multiple loading issue v2.1
if (typeof window !== 'undefined') {
    // Only set up a single initialization attempt
    setTimeout(() => {
        if (!themeManagementInitialized) {
            console.log('üé® Theme management component self-initialization attempt...');
            initializeThemeManagement();
        }
    }, 150);
}
</script>